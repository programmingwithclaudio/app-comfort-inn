<!-- report.html -->
{% extends 'dashboard_base.html' %}
{% block main_content %}
    <h2 class="section-header">Informe de Reservas</h2>

    <div class="panel">
        <div class="panel__header">
            <div class="input__wrapper">
            <form action="{{ url_for('admin.reservations_report') }}" method="GET" class="input__wrapper">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="search" name="search" placeholder="Buscar por nombre..." value="{{ request.args.get('search', '') }}">
                <button type="submit" class="button search">Buscar</button>
            </form>
            </div>
        </div>
            <div class="panel__body">
                <div class="filter__wrapper">
                    <div class="filter__controls">
                        <span class="filter__label">Estado:</span>
                        <select id="statusFilter" class="filter__select">
                            <option value="all">Todos</option>
                            <option value="PENDING">En progreso</option>
                            <option value="CONFIRMED">Completado</option>
                        </select>
                        <span class="filter__label">Fecha:</span>
                        <select id="dateFilter" class="filter__select">
                            <option value="all">Todos</option>
                            <option value="this-week">Esta semana</option>
                            <option value="this-month">Este mes</option>
                        </select>
                    </div>
                </div>
                <div class="panel__table">

                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>ID Reserva</th>
                            <th>Nombre del Cliente</th>

                            <th>Estado de la Reserva</th>
                            <th>Inicio de la Reserva</th>
                            <th>Fin de la Reserva</th>
                            <th>Tipo de Reserva</th>
                            <th>Adultos</th>
                            <th>Niños</th>
                            <th>Noches</th>
                            <th>Precio Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for  booking, reservation, customer, pricing in reservations.items %}
                            <tr>
                                <td>{{ booking.id }}</td>
                                <td>{{ customer.fullname }}</td>

                                <td>{{ booking.status }}</td>
                                <td>{{ reservation.start }}</td>
                                <td>{{ reservation.end }}</td>
                                <td>{{ reservation.type }}</td>
                                <td>{{ reservation.adults }}</td>
                                <td>{{ reservation.children }}</td>
                                <td>{{ pricing.nights }}</td>
                                <td>{{ pricing.total_price }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
    </div>
</div>
        <!-- Agrega la paginación -->
        <div class="pagination">
            {% if reservations.has_prev %}
                <a href="{{ url_for('admin.reservations_report', page=reservations.prev_num) }}">Previous</a>
            {% endif %}

            {% for page_num in reservations.iter_pages() %}
                {% if page_num %}
                    {% if page_num == reservations.page %}
                        <strong>{{ page_num }}</strong>
                    {% else %}
                        <a href="{{ url_for('admin.reservations_report', page=page_num) }}">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                    ...
                {% endif %}
            {% endfor %}

            {% if reservations.has_next %}
                <a href="{{ url_for('admin.reservations_report', page=reservations.next_num) }}">Next</a>
            {% endif %}
        </div>
    </div>
    <!-- Inicializar el selector de fecha y manejar envío del formulario -->
    <script>
    // JavaScript para filtrar la tabla
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = document.getElementById('statusFilter');
        const dateFilter = document.getElementById('dateFilter');
        const rows = document.querySelectorAll('#reportTable tbody tr');

        statusFilter.addEventListener('change', filter);
        dateFilter.addEventListener('change', filter);

        function filter() {
            const statusValue = statusFilter.value;
            const dateValue = dateFilter.value;

            rows.forEach(row => {
                const statusCell = row.querySelector('td:nth-child(4)').textContent.trim();
                const startDate = new Date(row.querySelector('td:nth-child(5)').textContent.trim());
                const endDate = new Date(row.querySelector('td:nth-child(6)').textContent.trim());

                // Filtrar por estado
                const statusMatch = statusValue === 'all' || statusCell === statusValue;

                // Filtrar por fecha
                let dateMatch = true;
                if (dateValue === 'this-week') {
                    const today = new Date();
                    const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                    dateMatch = startDate >= startOfWeek;
                } else if (dateValue === 'this-month') {
                    const today = new Date();
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateMatch = startDate >= startOfMonth;
                }

                // Mostrar u ocultar fila según los criterios de filtro
                if (statusMatch && dateMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    });
    </script>
{% endblock %}
